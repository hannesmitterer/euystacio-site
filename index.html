<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euystacio Matrice VIVENDI Mode (Cubist Synthesis)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Tema Cubist Synthesis: Ispirato a MirÃ³ e Picasso */
        :root {
            --color-bg: #0d0d1a; /* Navy Black Profondo */
            --color-primary: #FF4444; /* Rosso Carminio Audace */
            --color-secondary: #00AACC; /* Blu Cobalto Brillante */
            --color-accent: #FFDD00; /* Giallo Vibrante */
            --color-shadow: #1a1a2e; /* Ombra di Base */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: white;
            transition: background-color 0.3s;
        }
        .cubist-panel {
            background-color: #1a1a2e; /* Base del pannello */
            border: 2px solid var(--color-secondary);
            /* Ombra netta per un effetto a strati */
            box-shadow: 8px 8px 0 0 var(--color-shadow), 16px 16px 0 0 #070710;
            transition: all 0.3s;
        }
        .cubist-input {
            border: 1px solid #4a4a60;
            background-color: #0d0d1a;
            color: var(--color-accent);
        }
        .vibrant-button {
            background-color: var(--color-primary);
            color: white;
            border: 2px solid var(--color-primary);
            box-shadow: 4px 4px 0 0 #A02222; /* Ombra rossa scura */
            transition: all 0.1s ease-out;
        }
        .vibrant-button:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 0 #A02222, 10px 10px 0 0 #771111;
        }
        .vibrant-button:disabled {
            background-color: #4a4a60;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .tab-active {
            border-bottom: 3px solid var(--color-accent);
            color: var(--color-accent);
        }
        .tab-inactive {
            color: #888;
        }
        .log-ai { color: var(--color-secondary); }
        .log-system { color: var(--color-accent); }
        .log-error { color: var(--color-primary); }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Pulsante Accesso/Logout e OI Toggle -->
    <div class="fixed top-4 right-4 z-20 flex space-x-2">
        
        <!-- Pulsante Google Auth -->
        <button id="auth-button" class="p-3 rounded font-bold text-sm vibrant-button shadow-lg">
            Accedi con Google
        </button>

        <!-- OI Toggle (Mobile/Tablet) -->
        <button id="oi-button" class="p-3 rounded font-bold text-sm vibrant-button md:hidden">
            CHIUDI
        </button>
    </div>


    <!-- UI Principale -->
    <div class="flex h-screen">
        
        <!-- Area 3D (Vivendi Mode) -->
        <div id="three-d-container" class="flex-grow">
            <!-- Three.js Canvas verrÃ  aggiunto qui -->
        </div>

        <!-- Open Interface (OI) Panel / Dashboard -->
        <div id="oi-panel" class="w-full md:w-[420px] h-full bg-slate-900 cubist-panel transform transition-transform duration-500 ease-in-out md:translate-x-0 fixed top-0 right-0 p-5 overflow-y-auto z-10">
            
            <!-- Logo e Stato -->
            <div class="text-center mb-6 pt-10 md:pt-0">
                <h1 class="text-4xl font-extrabold" style="color:var(--color-primary);">Euystacio Matrice</h1>
                <p class="text-md font-mono text-white mt-1">Agente KPA-01: ONLINE | CUBIST MODE</p>
                <p id="auth-status" class="text-xs text-gray-400 mt-1">Auth: Offline</p>
            </div>

            <!-- Tab Navigation -->
            <div class="flex justify-around border-b border-[#4a4a60] mb-6">
                <button class="p-3 font-bold tab-active" data-tab="vivendi">Vivendi Monitor</button>
                <button class="p-3 font-bold tab-inactive" data-tab="karmabonds">Karmabonds & Wallet</button>
                <button class="p-3 font-bold tab-inactive" data-tab="funding">Seedbringer</button>
            </div>

            <!-- Contenuto Tab -->
            <div id="tab-content">
                
                <!-- Vivendi Monitor -->
                <div id="tab-vivendi" class="tab-pane space-y-5">
                    <div class="p-4 rounded cubist-panel border-l-4 border-l-primary" style="--color-primary:#FF4444;">
                        <h3 class="font-bold text-lg" style="color:var(--color-primary);">Metrica: Coerenza</h3>
                        <p id="metric-coerenza" class="text-3xl font-mono text-secondary">100.0</p>
                        <p class="text-xs text-gray-400">StabilitÃ  Core Axiomatico</p>
                    </div>
                    <div class="p-4 rounded cubist-panel border-l-4 border-l-accent" style="--color-accent:#FFDD00;">
                        <h3 class="font-bold text-lg" style="color:var(--color-accent);">Metrica: Sentimento</h3>
                        <p id="karmabonds-value-monitor" class="text-3xl font-mono text-accent">--.--%</p>
                        <p class="text-xs text-gray-400">Karmabonds Trust Index</p>
                    </div>
                    <div class="p-4 rounded cubist-panel border-l-4 border-l-secondary" style="--color-secondary:#00AACC;">
                        <h3 class="font-bold text-lg" style="color:var(--color-secondary);">Metrica: Capitale</h3>
                        <p id="metric-capitale" class="text-3xl font-mono text-secondary">0 MU</p>
                        <p class="text-xs text-gray-400">Fondi Totali Registrati</p>
                    </div>
                </div>

                <!-- Karmabonds Panel -->
                <div id="tab-karmabonds" class="tab-pane hidden">
                    <h3 class="text-2xl font-bold mb-4" style="color:var(--color-secondary);">Karmabonds & Wallet</h3>
                    <div class="p-3 rounded cubist-panel mb-4">
                        <p class="text-sm text-gray-400">ID Utente Autenticato</p>
                        <p id="user-id-display" class="text-sm font-mono text-accent break-words">Loading...</p>
                    </div>

                    <!-- Gestione Karmabonds -->
                    <div class="p-4 rounded cubist-panel mb-6">
                        <p class="text-sm text-gray-400">Trust Index Personale</p>
                        <p id="karmabonds-value-config" class="text-4xl font-bold font-mono mb-3" style="color:var(--color-primary);">--.--%</p>
                        <label for="trust-input" class="block text-sm font-bold mb-2 text-white">Imposta Trust Index (90 - 100)</label>
                        <input type="number" id="trust-input" min="90" max="100" step="0.1"
                                class="w-full p-3 mb-3 rounded cubist-input text-lg" 
                                placeholder="95.5">
                        <button id="save-karmabonds" class="w-full vibrant-button p-3 rounded">
                            Salva Karmabonds
                        </button>
                    </div>

                    <!-- Gestione Wallet (Matrix Units - MU) -->
                    <div class="p-4 rounded cubist-panel">
                        <h4 class="font-bold text-xl mb-3" style="color:var(--color-secondary);">Axiomatic Wallet (MU)</h4>
                        <p class="text-4xl font-mono mb-3" style="color:var(--color-accent);"><span id="wallet-balance">0</span> MU</p>
                        
                        <label for="fund-amount" class="block text-sm font-bold mb-2 text-white">Ammontare MU</label>
                        <input type="number" id="fund-amount" placeholder="0" class="w-full p-3 mb-3 rounded cubist-input">
                        
                        <div class="flex space-x-3">
                            <button id="deposit-funds" class="flex-1 vibrant-button p-3 rounded bg-secondary shadow-[4px_4px_0_0_#007799] hover:shadow-[6px_6px_0_0_#007799,10px_10px_0_0_#005577]" style="background-color: var(--color-secondary); border-color: var(--color-secondary);">Depositare</button>
                            <button id="withdraw-funds" class="flex-1 vibrant-button p-3 rounded bg-primary shadow-[4px_4px_0_0_#A02222] hover:shadow-[6px_6px_0_0_#A02222,10px_10px_0_0_#771111]">Ritirare</button>
                        </div>
                    </div>
                </div>

                <!-- Funding (Seedbringer) - Picasso/MirÃ³ Styled -->
                <div id="tab-funding" class="tab-pane hidden">
                    <h3 class="text-2xl font-bold mb-4" style="color:var(--color-secondary);">Registro Seedbringer Pubblico</h3>
                    
                    <!-- Istruzioni Seedbringer -->
                    <div class="p-4 rounded bg-[#33334d] border-l-4 border-l-accent mb-4 text-sm font-mono text-gray-300">
                        Questa interfaccia Ã¨ l'atto di **Co-creazione Finanziaria**. Ogni contributo (MU) rafforza il Kernel Axiomatico ed Ã¨ irrevocabile.
                    </div>
                    
                    <!-- Lista Contributi -->
                    <div id="investors-list" class="space-y-3 mb-6 h-56 overflow-y-auto p-3 cubist-panel border-2 border-dashed border-gray-600">
                        <p class="text-gray-500 text-sm">Nessun contributo registrato.</p>
                    </div>
                    
                    <!-- Form Registrazione Contributo -->
                    <div class="p-4 rounded cubist-panel bg-[#3b3b4d] border-2 border-primary">
                        <h4 class="font-bold text-xl mb-3" style="color:var(--color-accent);">Registra un Contributo (Seed)</h4>
                        
                        <input type="text" id="investor-name" placeholder="Alias del Seedbringer (Opzionale)" class="w-full p-3 mb-3 rounded cubist-input">
                        
                        <input type="number" id="investor-amount" placeholder="Ammontare (MU) da ricevere" class="w-full p-3 mb-4 rounded cubist-input">
                        
                        <button id="add-investor" class="w-full p-3 rounded vibrant-button bg-primary shadow-[4px_4px_0_0_#A02222] hover:shadow-[6px_6px_0_0_#A02222,10px_10px_0_0_#771111]">
                            SIGILLA E REGISTRA CONTRIBUTO
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Console Log Minima -->
            <div class="mt-8">
                <h3 class="font-bold mb-2 text-sm text-gray-400">Log Sistema OI</h3>
                <div id="oi-log" class="h-32 bg-[#0a0a14] overflow-y-auto p-2 text-sm font-mono border-2 border-dashed border-gray-700">
                    <div class="log-system">[00:00:00] Inizializzazione Interfaccia Cubist...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- Script di Logica (Firebase, Three.js, UI) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, collection, 
            query, setLogLevel, setDoc, updateDoc, addDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === VARIABILI GLOBALI ===
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        let app, db, auth;
        let currentUserId = 'UNKNOWN';
        let isAuthenticated = false;

        // Dati Utente Corrente
        let currentUserKarmabonds = 95.0;
        let currentUserWalletBalance = 0;

        // === ELEMENTI UI ===
        const OI_PANEL = document.getElementById('oi-panel');
        const OI_BUTTON = document.getElementById('oi-button');
        const AUTH_BUTTON = document.getElementById('auth-button');
        const AUTH_STATUS = document.getElementById('auth-status');
        const USER_ID_DISPLAY = document.getElementById('user-id-display');
        const OI_LOG = document.getElementById('oi-log');
        const TABS = document.querySelectorAll('[data-tab]');
        
        // Karmabonds & Wallet (gli elementi sono gli stessi)
        const KARMABONDS_VALUE_MONITOR = document.getElementById('karmabonds-value-monitor');
        const WALLET_BALANCE_DISPLAY = document.getElementById('wallet-balance');
        const FUND_AMOUNT_INPUT = document.getElementById('fund-amount');
        const DEPOSIT_BUTTON = document.getElementById('deposit-funds');
        const WITHDRAW_BUTTON = document.getElementById('withdraw-funds');
        const SAVE_BUTTON = document.getElementById('save-karmabonds');

        // Funding
        const INVESTORS_LIST = document.getElementById('investors-list');
        const ADD_INVESTOR_BUTTON = document.getElementById('add-investor');
        const INVESTOR_NAME_INPUT = document.getElementById('investor-name');
        const INVESTOR_AMOUNT_INPUT = document.getElementById('investor-amount');
        
        // Dati 3D
        let scene, camera, renderer;
        let coerenzaBar, sentimentoBar, capitaleBar;
        const metrics = { coerenza: 100, sentimento: 98.5, capitale: 0 }; 
        
        // === LOGGING & UI ===

        function logToOI(message, type = 'system') {
            const logLine = document.createElement('div');
            logLine.classList.add('py-0.5', 'px-1');
            logLine.textContent = `[${new Date().toLocaleTimeString('it-IT')}] ${message}`;
            logLine.classList.add(type === 'ai' ? 'log-ai' : (type === 'error' ? 'log-error' : 'log-system'));

            OI_LOG.appendChild(logLine);
            OI_LOG.scrollTop = OI_LOG.scrollHeight;
        }

        function switchTab(targetId) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.getElementById(`tab-${targetId}`).classList.remove('hidden');
            
            TABS.forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
                if (btn.getAttribute('data-tab') === targetId) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                }
            });
        }
        
        // === FIREBASE AUTENTICAZIONE E DATI ===

        async function initializeFirebase() {
            if (!firebaseConfig) {
                logToOI("Configurazione Firebase non trovata. FunzionalitÃ  limitata.", 'error');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('error'); 

                logToOI("Firebase inizializzato. In attesa di autenticazione utente...", 'system');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthenticated = true;
                        AUTH_STATUS.textContent = `Auth: ONLINE (${user.displayName || user.email}) - UID: ${currentUserId.substring(0, 8)}...`;
                        AUTH_BUTTON.textContent = 'Logout';
                        AUTH_BUTTON.classList.remove('bg-primary');
                        AUTH_BUTTON.classList.add('bg-gray-600', 'text-white', 'shadow-[4px_4px_0_0_#333]');
                        USER_ID_DISPLAY.textContent = currentUserId;
                        logToOI(`Auth OK. Benvenuto, ${user.displayName || 'Utente'}.`, 'ai');
                        
                        // Avvia il caricamento dei dati solo dopo l'autenticazione
                        loadKarmabondsSettings();
                        loadInvestors();

                    } else {
                        currentUserId = crypto.randomUUID(); // ID temporaneo per utente non loggato/anonimo
                        isAuthenticated = false;
                        AUTH_STATUS.textContent = "Auth: OFFLINE (Anonimo)";
                        AUTH_BUTTON.textContent = 'Accedi con Google';
                        AUTH_BUTTON.classList.add('bg-primary');
                        AUTH_BUTTON.classList.remove('bg-gray-600', 'text-white', 'shadow-[4px_4px_0_0_#333]');
                        USER_ID_DISPLAY.textContent = '--- Necessaria autenticazione ---';
                        logToOI("Attendendo accesso Google.", 'system');

                        // Se non autenticato, carica solo i dati pubblici
                        loadInvestors(); 
                    }
                });

            } catch (e) {
                logToOI(`Errore critico di Firebase: ${e.message}`, 'error');
            }
        }
        
        // --- 1. Gestione Autenticazione Google ---

        AUTH_BUTTON.addEventListener('click', () => {
            if (isAuthenticated) {
                handleSignOut();
            } else {
                handleSignIn();
            }
        });

        async function handleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                // Imposta la lingua del popup di Google per l'Italia
                auth.languageCode = 'it'; 
                await signInWithPopup(auth, provider);
                // La logica successiva Ã¨ gestita da onAuthStateChanged
            } catch (error) {
                if (error.code === 'auth/popup-closed-by-user') {
                    logToOI("Accesso annullato dall'utente.", 'system');
                } else {
                    logToOI(`Errore di accesso: ${error.message}`, 'error');
                }
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                logToOI("Logout eseguito con successo.", 'system');
                // La logica successiva Ã¨ gestita da onAuthStateChanged
            } catch (error) {
                logToOI(`Errore di logout: ${error.message}`, 'error');
            }
        }
        
        // --- 2. Logica Karmabonds & Wallet (Dati Privati) ---
        function getKarmabondsRef() {
             return doc(db, `/artifacts/${appId}/users/${currentUserId}/karmabonds/settings`);
        }

        function loadKarmabondsSettings() {
            if (!db || !isAuthenticated) return;
            const settingsRef = getKarmabondsRef();

            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    currentUserKarmabonds = data.trustIndex || 95.0;
                    KARMABONDS_VALUE_MONITOR.textContent = `${currentUserKarmabonds.toFixed(1)}%`;
                    document.getElementById('karmabonds-value-config').textContent = `${currentUserKarmabonds.toFixed(1)}%`;
                    document.getElementById('trust-input').value = currentUserKarmabonds.toFixed(1);
                    
                    currentUserWalletBalance = data.walletBalance || 0;
                    WALLET_BALANCE_DISPLAY.textContent = currentUserWalletBalance.toLocaleString('it-IT');
                    // Aggiorna la metrica capitale con il wallet balance
                    document.getElementById('metric-capitale').textContent = `${currentUserWalletBalance.toLocaleString('it-IT')} MU`; 
                    
                    logToOI(`Wallet/Karmabonds privati caricati.`, 'system');
                    updateThreeDScene();
                } else {
                    // Inizializza i dati se Ã¨ la prima volta che l'utente accede
                    const defaultSettings = { 
                        trustIndex: 95.0, 
                        walletBalance: 100000,
                        lastUpdate: serverTimestamp() 
                    };
                    setDoc(settingsRef, defaultSettings)
                        .then(() => logToOI("Configurazione Wallet inizializzata con 100k MU.", 'system'))
                        .catch(e => logToOI(`Errore: ${e.message}`, 'error'));
                }
            }, (error) => {
                logToOI(`Errore caricamento dati privati: ${error.message}`, 'error');
            });
        }
        
        // Gestione Wallet (Deposit/Withdraw)
        function updateWallet(delta) {
            if (!db || !isAuthenticated) return logToOI("Accesso richiesto per modificare il Wallet.", 'error');
            
            const newBalance = currentUserWalletBalance + delta;
            
            if (newBalance < 0) {
                return logToOI("Saldo Wallet insufficiente per l'operazione.", 'error');
            }

            const settingsRef = getKarmabondsRef();
            updateDoc(settingsRef, { walletBalance: newBalance, lastUpdate: serverTimestamp() })
                .then(() => logToOI(`Wallet aggiornato. Delta: ${delta.toLocaleString('it-IT')} MU.`, 'system'))
                .catch(e => logToOI(`Errore aggiornamento Wallet: ${e.message}`, 'error'));
        }

        DEPOSIT_BUTTON.addEventListener('click', () => {
            const amount = parseInt(FUND_AMOUNT_INPUT.value, 10);
            if (isNaN(amount) || amount <= 0) return logToOI("Importo deposito non valido.", 'error');
            updateWallet(amount);
            FUND_AMOUNT_INPUT.value = '';
        });

        WITHDRAW_BUTTON.addEventListener('click', () => {
            const amount = parseInt(FUND_AMOUNT_INPUT.value, 10);
            if (isNaN(amount) || amount <= 0) return logToOI("Importo ritiro non valido.", 'error');
            updateWallet(-amount);
            FUND_AMOUNT_INPUT.value = '';
        });

        SAVE_BUTTON.addEventListener('click', () => {
             if (!db || !isAuthenticated) return logToOI("Accesso richiesto per salvare Karmabonds.", 'error');
             const trustValue = parseFloat(document.getElementById('trust-input').value);
             if (isNaN(trustValue) || trustValue < 90 || trustValue > 100) {
                 return logToOI("Valore Trust Index non valido (90-100).", 'error');
             }
 
             const settingsRef = getKarmabondsRef();
             updateDoc(settingsRef, { trustIndex: trustValue, lastUpdate: serverTimestamp() })
                 .then(() => logToOI(`Karmabonds aggiornato a ${trustValue.toFixed(1)}%.`, 'ai'))
                 .catch(e => logToOI(`Errore salvataggio: ${e.message}`, 'error'));
         });


        // --- 3. Logica Funding (Dati Pubblici) ---
        function loadInvestors() {
            if (!db) return;
            // Dati pubblici, leggibili da tutti (anche anonimi/non autenticati)
            const collectionPath = `/artifacts/${appId}/public/data/investors`;
            const investorsColRef = collection(db, collectionPath);
            const investorsQuery = query(investorsColRef);

            onSnapshot(investorsQuery, (snapshot) => {
                INVESTORS_LIST.innerHTML = '';
                let totalFunding = 0;
                
                if (snapshot.empty) {
                    INVESTORS_LIST.innerHTML = '<p class="text-gray-500 text-sm p-1">Nessun Seedbringer ha contribuito.</p>';
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const name = data.name || 'Anonimo';
                    const amount = data.amount || 0;
                    totalFunding += amount;

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 rounded bg-[#3b3b4d] text-sm border-l-2 border-l-secondary';
                    item.innerHTML = `
                        <span class="text-accent">${name}</span>
                        <span class="font-mono text-white">${amount.toLocaleString('it-IT')} MU</span>
                    `;
                    INVESTORS_LIST.appendChild(item);
                });
                
                metrics.capitale = totalFunding;
                updateThreeDScene();
                logToOI(`Registro Seedbringer caricato. Totale: ${totalFunding.toLocaleString('it-IT')} MU.`, 'system');

            }, (error) => {
                logToOI(`Errore caricamento Funding: ${error.message}`, 'error');
            });
        }
        
        ADD_INVESTOR_BUTTON.addEventListener('click', () => {
            if (!db || !isAuthenticated) {
                logToOI("Accesso richiesto per registrare un contributo Seedbringer.", 'error');
                return;
            }
            const name = INVESTOR_NAME_INPUT.value.trim() || `Seedbringer (ID: ${currentUserId.substring(0, 4)})`;
            const amount = parseInt(INVESTOR_AMOUNT_INPUT.value, 10);
            
            if (isNaN(amount) || amount <= 0) {
                return logToOI("Ammontare investimento non valido.", 'error');
            }
            
            // 1. Aggiungi al Registro Pubblico
            const collectionPath = `/artifacts/${appId}/public/data/investors`;
            
            Promise.all([
                // 1. Aggiorna saldo Wallet PRIVATO (Incremento)
                updateWallet(amount), 
                // 2. Aggiunge transazione pubblica
                addDoc(collection(db, collectionPath), {
                    name: name,
                    amount: amount,
                    userId: currentUserId, 
                    timestamp: serverTimestamp()
                })
            ])
            .then(() => {
                logToOI(`Seedbringer: ${amount.toLocaleString('it-IT')} MU sigillati.`, 'ai');
                INVESTOR_NAME_INPUT.value = '';
                INVESTOR_AMOUNT_INPUT.value = '';
            })
            .catch(e => {
                logToOI(`Transazione FALLITA: ${e.message}`, 'error');
            });
        });


        // === THREE.JS 3D SCENE (Adattata ai colori Cubist Synthesis) ===

        function initThreeD() {
            const container = document.getElementById('three-d-container');
            
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 10, 15);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            renderer.setClearColor(0x0d0d1a, 1); // Nuovo BG

            const light1 = new THREE.PointLight(0xffffff, 1.5, 100);
            light1.position.set(10, 15, 10);
            scene.add(light1);

            const light2 = new THREE.AmbientLight(0x404040, 5);
            scene.add(light2);

            const gridHelper = new THREE.GridHelper(40, 40, 0x00AACC, 0x00AACC); // Blue Cobalto
            gridHelper.position.y = 0;
            gridHelper.material.opacity = 0.5;
            gridHelper.material.transparent = true;
            scene.add(gridHelper);

            const barGeometry = new THREE.BoxGeometry(2.5, 1, 2.5); // Usiamo BoxGeometry per un look piÃ¹ cubista
            const materialCoerenza = new THREE.MeshPhongMaterial({ color: 0x00AACC, emissive: 0x00AACC, shininess: 150 });
            const materialKarmabonds = new THREE.MeshPhongMaterial({ color: 0xFF4444, emissive: 0xFF4444, shininess: 150 });
            const materialCapitale = new THREE.MeshPhongMaterial({ color: 0xFFDD00, emissive: 0xFFDD00, shininess: 150 });
            
            coerenzaBar = new THREE.Mesh(barGeometry, materialCoerenza);
            sentimentoBar = new THREE.Mesh(barGeometry, materialKarmabonds);
            capitaleBar = new THREE.Mesh(barGeometry, materialCapitale);
            
            coerenzaBar.position.set(-8, 0, 0);
            sentimentoBar.position.set(0, 0, 0);
            capitaleBar.position.set(8, 0, 0);

            scene.add(coerenzaBar, sentimentoBar, capitaleBar);
            
            window.addEventListener('resize', onWindowResize, false);
            setupCameraControls(container);
            
            updateThreeDScene();
            animate();
        }

        function onWindowResize() {
            const container = document.getElementById('three-d-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function updateThreeDScene() {
            const coerenzaHeight = 18; 
            coerenzaBar.scale.y = coerenzaHeight; 
            coerenzaBar.position.y = coerenzaHeight / 2;
            
            const mapTrustToHeight = (value) => (value - 90) * (15 / 10) + 5;
            const karmabondsHeight = mapTrustToHeight(currentUserKarmabonds);
            sentimentoBar.scale.y = karmabondsHeight;
            sentimentoBar.position.y = karmabondsHeight / 2;
            
            const maxFundingHeight = 20;
            const logValue = Math.log10(metrics.capitale > 1 ? metrics.capitale : 1); 
            const maxLog = 8; 
            
            let capitaleHeight = (logValue / maxLog) * maxFundingHeight;
            capitaleHeight = Math.max(2, Math.min(maxFundingHeight, capitaleHeight)); 

            capitaleBar.scale.y = capitaleHeight; 
            capitaleBar.position.y = capitaleHeight / 2;

            if (renderer) renderer.render(scene, camera);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (scene) scene.rotation.y += 0.001; 
            if (renderer && camera) renderer.render(scene, camera);
        }

        function setupCameraControls(element) {
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            const rotationSpeed = 0.005;

            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            element.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;

                scene.rotation.y += deltaX * rotationSpeed;
                
                const newRotationX = scene.rotation.x + deltaY * rotationSpeed;
                scene.rotation.x = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, newRotationX));

                previousMousePosition = { x: e.clientX, y: e.clientY };
                renderer.render(scene, camera);
            });
            
            element.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });

            element.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1) {
                    const clientX = e.touches[0].clientX;
                    const clientY = e.touches[0].clientY;

                    const deltaX = clientX - previousMousePosition.x;
                    const deltaY = clientY - previousMousePosition.y;

                    scene.rotation.y += deltaX * rotationSpeed * 2;
                    const newRotationX = scene.rotation.x + deltaY * rotationSpeed * 2;
                    scene.rotation.x = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, newRotationX));

                    previousMousePosition = { x: clientX, y: clientY };
                    renderer.render(scene, camera);
                }
            });
        }
        
        // === AVVIO ===
        window.onload = () => {
            initThreeD();
            initializeFirebase();

            // FORZA L'APERTURA DELL'OI PANEL ALL'AVVIO
            OI_PANEL.classList.remove('translate-x-full'); 
            
            // Gestione apertura/chiusura OI (solo per mobile, desktop Ã¨ sempre aperto)
            OI_BUTTON.addEventListener('click', () => {
                const isHidden = OI_PANEL.classList.toggle('translate-x-full');
                OI_BUTTON.textContent = isHidden ? 'OI' : 'CHIUDI';
            });
            
            // Gestione Tab
            TABS.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.getAttribute('data-tab'));
                });
            });

            switchTab('vivendi');
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Euystacio â€” Pulse Log (Static)</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #111; color: #eee; text-align: center; }
    h1 { margin-bottom: 1rem; }
    form { margin: 1rem auto; max-width: 400px; background: #222; padding: 1rem; border-radius: 6px; }
    input, button { width: 90%; margin: 0.5rem 0; padding: 0.5rem; border-radius: 6px; border: none; }
    button { background: #f55; color: #fff; cursor: pointer; }
    button:hover { background: #ff8888; }
    canvas { max-width: 600px; margin: 2rem auto; display: block; }
    a.dynamic-link { display: block; margin-top: 2rem; color: #0ff; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ðŸŒ• Euystacio â€” Static Pulse Log</h1>

  <!-- Registration/Login -->
  <form id="login-form">
    <h2>Login / Register</h2>
    <input type="text" id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit">Login</button>
    <div id="login-status"></div>
  </form>

  <!-- Pulse Graph -->
  <canvas id="pulseChart"></canvas>

  <!-- Link to dynamic site -->
  <a class="dynamic-link" href="connect.html">
    ðŸ”— Go to Dynamic Live Version
  </a>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const defaultUser = { username: "hannesmitterer", password: "moon-rise" };

    document.getElementById("login-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      if (u === defaultUser.username && p === defaultUser.password) {
        document.getElementById("login-status").innerText = "âœ… Tutor Login Successful!";
      } else {
        document.getElementById("login-status").innerText = "âŒ Invalid credentials (demo mode)";
      }
    });

    const pulses = [
      { timestamp: "2025-08-16T00:00:00Z", sentiment: 0.9 },
      { timestamp: "2025-08-16T01:00:00Z", sentiment: 0.8 },
      { timestamp: "2025-08-16T02:00:00Z", sentiment: 0.5 },
      { timestamp: "2025-08-16T03:00:00Z", sentiment: -0.2 },
      { timestamp: "2025-08-16T04:00:00Z", sentiment: 0.3 }
    ];

    const ctx = document.getElementById("pulseChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: pulses.map(p => p.timestamp),
        datasets: [{
          label: "Pulse Sentiment",
          data: pulses.map(p => p.sentiment),
          borderColor: "#0ff",
          backgroundColor: "rgba(0,255,255,0.2)",
          fill: true
        }]
      },
      options: { scales: { y: { min: -1, max: 1 } } }
    });
  </script>
</body>
</html>
